import { jsx as _jsx, jsxs as _jsxs, Fragment as _Fragment } from "react/jsx-runtime";
import { useState, useEffect } from 'react';
import { RefreshCw, Search, Filter, Eye, Server, Wifi, WifiOff, Globe } from 'lucide-react';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { useExporterApi } from '../lib/exporterApi';
import { useAuth } from '../lib/useAuth';
import { useNotification } from './NotificationProvider';
import { Tooltip } from '@/components/ui/tooltip';
import { Modal } from '@/components/ui/modal';
const DevicesPrometheusPage = () => {
    const [devices, setDevices] = useState([]);
    const [loading, setLoading] = useState(true);
    const [searchTerm, setSearchTerm] = useState('');
    const [statusFilter, setStatusFilter] = useState('all');
    const [platformFilter, setPlatformFilter] = useState('');
    const [exporterTypeFilter, setExporterTypeFilter] = useState('all');
    const [selectedDevice, setSelectedDevice] = useState(null);
    const { getAllDevices } = useExporterApi();
    const { isSuperAdmin } = useAuth();
    const { notify } = useNotification();
    useEffect(() => {
        loadData();
    }, []);
    const loadData = async () => {
        try {
            setLoading(true);
            const devicesData = await getAllDevices();
            setDevices(devicesData);
        }
        catch (error) {
            notify('Ошибка при загрузке данных', 'error');
        }
        finally {
            setLoading(false);
        }
    };
    const filteredDevices = devices.filter(device => {
        const matchesSearch = (device.mac || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
            (device.device_id || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
            (device.name || '').toLowerCase().includes(searchTerm.toLowerCase()) ||
            (device.ip && device.ip.toLowerCase().includes(searchTerm.toLowerCase())) ||
            (device.platform_id || '').toLowerCase().includes(searchTerm.toLowerCase());
        const matchesStatus = statusFilter === 'all' || device.status_text === statusFilter;
        const matchesPlatform = !platformFilter || device.platform_id === platformFilter;
        const matchesType = exporterTypeFilter === 'all' || (device.platform_type || getDeviceType(device)) === exporterTypeFilter;
        return matchesSearch && matchesStatus && matchesPlatform && matchesType;
    });
    const getStatusIcon = (status) => {
        return status === 'online' ?
            _jsx(Wifi, { className: "text-green-500", size: 16 }) :
            _jsx(WifiOff, { className: "text-red-500", size: 16 });
    };
    const getStatusText = (status) => {
        return status === 'online' ? 'Онлайн' : 'Оффлайн';
    };
    const formatDate = (dateString) => {
        return new Date(dateString).toLocaleString('ru-RU');
    };
    const uniquePlatforms = [...new Set(devices.map(d => d.platform_id))];
    function getDeviceType(device) {
        if (device.device_id || device.player_version || device.activation_state)
            return 'addreality';
        return 'cubicmedia';
    }
    if (!isSuperAdmin) {
        return (_jsx("div", { className: "p-6", children: _jsxs("div", { className: "bg-red-900/20 border border-red-500/50 rounded-lg p-4", children: [_jsx("h2", { className: "text-red-400 font-semibold", children: "\u0414\u043E\u0441\u0442\u0443\u043F \u0437\u0430\u043F\u0440\u0435\u0449\u0435\u043D" }), _jsx("p", { className: "text-gray-300 mt-2", children: "\u041F\u0440\u043E\u0441\u043C\u043E\u0442\u0440 \u0443\u0441\u0442\u0440\u043E\u0439\u0441\u0442\u0432 \u0438\u0437 Prometheus \u0434\u043E\u0441\u0442\u0443\u043F\u0435\u043D \u0442\u043E\u043B\u044C\u043A\u043E \u0441\u0443\u043F\u0435\u0440-\u0430\u0434\u043C\u0438\u043D\u0438\u0441\u0442\u0440\u0430\u0442\u043E\u0440\u0430\u043C." })] }) }));
    }
    return (_jsxs("div", { className: "p-6", children: [_jsxs("div", { className: "flex justify-between items-center mb-6", children: [_jsxs("div", { children: [_jsx("h1", { className: "text-2xl font-bold text-gray-100", children: "\u0423\u0441\u0442\u0440\u043E\u0439\u0441\u0442\u0432\u0430 \u0438\u0437 Prometheus" }), _jsxs("p", { className: "text-gray-400 mt-1", children: ["\u0421\u043F\u0438\u0441\u043E\u043A \u0432\u0441\u0435\u0445 \u0443\u0441\u0442\u0440\u043E\u0439\u0441\u0442\u0432, \u043F\u043E\u043B\u0443\u0447\u0435\u043D\u043D\u044B\u0445 \u0438\u0437 \u043C\u0435\u0442\u0440\u0438\u043A Prometheus.", _jsx("br", {}), _jsx("span", { className: "text-blue-400", children: "CubicMedia" }), " \u2014 \u043F\u043E MAC-\u0430\u0434\u0440\u0435\u0441\u0443, ", _jsx("span", { className: "text-orange-400", children: "AddReality" }), " \u2014 \u043F\u043E device_id. \u041F\u043E\u0434\u0434\u0435\u0440\u0436\u0438\u0432\u0430\u044E\u0442\u0441\u044F \u043E\u0431\u0430 \u0442\u0438\u043F\u0430 \u044D\u043A\u0441\u043F\u043E\u0440\u0442\u0451\u0440\u043E\u0432."] })] }), _jsxs("button", { onClick: loadData, disabled: loading, className: "bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors disabled:opacity-50", children: [_jsx(RefreshCw, { size: 16, className: loading ? 'animate-spin' : '' }), "\u041E\u0431\u043D\u043E\u0432\u0438\u0442\u044C"] })] }), _jsx("div", { className: "bg-gray-800 rounded-lg border border-gray-700 p-4 mb-6", children: _jsxs("div", { className: "grid grid-cols-1 md:grid-cols-5 gap-4", children: [_jsxs("div", { children: [_jsx("label", { className: "block text-sm font-medium text-gray-300 mb-2", children: "\u041F\u043E\u0438\u0441\u043A" }), _jsxs("div", { className: "relative", children: [_jsx(Search, { className: "absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400", size: 16 }), _jsx("input", { type: "text", value: searchTerm, onChange: (e) => setSearchTerm(e.target.value), className: "w-full pl-10 pr-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-100 focus:border-blue-500 focus:outline-none", placeholder: "MAC, IP \u0438\u043B\u0438 Platform ID" })] })] }), _jsxs("div", { children: [_jsx("label", { className: "block text-sm font-medium text-gray-300 mb-2", children: "\u0421\u0442\u0430\u0442\u0443\u0441" }), _jsxs("select", { value: statusFilter, onChange: (e) => setStatusFilter(e.target.value), className: "w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-100 focus:border-blue-500 focus:outline-none", children: [_jsx("option", { value: "all", children: "\u0412\u0441\u0435" }), _jsx("option", { value: "online", children: "\u041E\u043D\u043B\u0430\u0439\u043D" }), _jsx("option", { value: "offline", children: "\u041E\u0444\u0444\u043B\u0430\u0439\u043D" })] })] }), _jsxs("div", { children: [_jsx("label", { className: "block text-sm font-medium text-gray-300 mb-2", children: "\u041F\u043B\u0430\u0442\u0444\u043E\u0440\u043C\u0430" }), _jsxs("select", { value: platformFilter, onChange: (e) => setPlatformFilter(e.target.value), className: "w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-100 focus:border-blue-500 focus:outline-none", children: [_jsx("option", { value: "", children: "\u0412\u0441\u0435 \u043F\u043B\u0430\u0442\u0444\u043E\u0440\u043C\u044B" }), uniquePlatforms.map(platform => (_jsx("option", { value: platform, children: platform }, platform)))] })] }), _jsxs("div", { children: [_jsx("label", { className: "block text-sm font-medium text-gray-300 mb-2", children: "\u0422\u0438\u043F \u044D\u043A\u0441\u043F\u043E\u0440\u0442\u0451\u0440\u0430" }), _jsxs("select", { value: exporterTypeFilter, onChange: e => setExporterTypeFilter(e.target.value), className: "w-full px-3 py-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-100 focus:border-blue-500 focus:outline-none", children: [_jsx("option", { value: "all", children: "\u0412\u0441\u0435" }), _jsx("option", { value: "cubicmedia", children: "CubicMedia" }), _jsx("option", { value: "addreality", children: "AddReality" })] })] }), _jsx("div", { className: "flex items-end", children: _jsxs("div", { className: "text-sm text-gray-400", children: ["\u041D\u0430\u0439\u0434\u0435\u043D\u043E: ", _jsx("span", { className: "text-gray-100 font-medium", children: filteredDevices.length }), " \u0438\u0437 ", devices.length] }) })] }) }), _jsxs("div", { className: "bg-gray-800 rounded-lg border border-gray-700", children: [_jsx("div", { className: "p-4 border-b border-gray-700", children: _jsxs("h2", { className: "text-lg font-semibold text-gray-100 flex items-center", children: [_jsx(Server, { className: "mr-2 text-blue-400", size: 20 }), "\u0423\u0441\u0442\u0440\u043E\u0439\u0441\u0442\u0432\u0430"] }) }), loading ? (_jsxs("div", { className: "p-8 text-center", children: [_jsx("div", { className: "animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mx-auto" }), _jsx("p", { className: "text-gray-400 mt-2", children: "\u0417\u0430\u0433\u0440\u0443\u0437\u043A\u0430 \u0443\u0441\u0442\u0440\u043E\u0439\u0441\u0442\u0432..." })] })) : devices.length === 0 ? (_jsxs("div", { className: "p-8 text-center", children: [_jsx(Server, { className: "text-gray-500 mx-auto mb-4", size: 48 }), _jsx("h3", { className: "text-lg font-medium text-gray-300 mb-2", children: "\u041D\u0435\u0442 \u0443\u0441\u0442\u0440\u043E\u0439\u0441\u0442\u0432" }), _jsx("p", { className: "text-gray-500", children: "\u0423\u0441\u0442\u0440\u043E\u0439\u0441\u0442\u0432\u0430 \u043D\u0435 \u043D\u0430\u0439\u0434\u0435\u043D\u044B \u0432 \u043C\u0435\u0442\u0440\u0438\u043A\u0430\u0445 Prometheus" })] })) : filteredDevices.length === 0 ? (_jsxs("div", { className: "p-8 text-center", children: [_jsx(Filter, { className: "text-gray-500 mx-auto mb-4", size: 48 }), _jsx("h3", { className: "text-lg font-medium text-gray-300 mb-2", children: "\u041D\u0435\u0442 \u0440\u0435\u0437\u0443\u043B\u044C\u0442\u0430\u0442\u043E\u0432" }), _jsx("p", { className: "text-gray-500", children: "\u041F\u043E\u043F\u0440\u043E\u0431\u0443\u0439\u0442\u0435 \u0438\u0437\u043C\u0435\u043D\u0438\u0442\u044C \u0444\u0438\u043B\u044C\u0442\u0440\u044B \u043F\u043E\u0438\u0441\u043A\u0430" })] })) : (_jsx("div", { className: "overflow-x-auto", children: _jsxs("table", { className: "w-full", children: [_jsx("thead", { children: _jsxs("tr", { className: "border-b border-gray-700", children: [_jsx("th", { className: "text-left py-3 px-4 text-gray-400 font-medium", children: "\u0418\u0441\u0442\u043E\u0447\u043D\u0438\u043A" }), _jsx("th", { className: "text-left py-3 px-4 text-gray-400 font-medium", children: "ID/MAC" }), _jsx("th", { className: "text-left py-3 px-4 text-gray-400 font-medium", children: "\u0418\u043C\u044F" }), _jsx("th", { className: "text-left py-3 px-4 text-gray-400 font-medium", children: "\u0421\u0442\u0430\u0442\u0443\u0441" }), _jsx("th", { className: "text-left py-3 px-4 text-gray-400 font-medium", children: "IP" }), _jsx("th", { className: "text-left py-3 px-4 text-gray-400 font-medium", children: "\u041F\u043B\u0430\u0442\u0444\u043E\u0440\u043C\u0430" }), _jsx("th", { className: "text-left py-3 px-4 text-gray-400 font-medium", children: "\u041F\u043E\u0434\u0440\u043E\u0431\u043D\u0435\u0435" })] }) }), _jsx("tbody", { children: filteredDevices.map((device, index) => {
                                        const type = (device.platform_type || getDeviceType(device));
                                        return (_jsxs("tr", { className: "border-b border-gray-700 hover:bg-gray-750 transition-colors cursor-pointer", onClick: () => setSelectedDevice(device), children: [_jsx("td", { className: "py-3 px-4", children: type === 'cubicmedia' ? (_jsxs(Badge, { className: "bg-blue-900/30 text-blue-400 flex items-center gap-1", children: [_jsx(Server, { size: 12 }), " CubicMedia"] })) : (_jsxs(Badge, { className: "bg-orange-900/30 text-orange-400 flex items-center gap-1", children: [_jsx(Globe, { size: 12 }), " AddReality"] })) }), _jsx("td", { className: "py-3 px-4 font-mono", children: type === 'addreality' ? (device.device_id || '-') : (device.mac || device.mac_address || '-') }), _jsx("td", { className: "py-3 px-4", children: _jsx("span", { className: "text-gray-300", children: device.name || '-' }) }), _jsx("td", { className: "py-3 px-4", children: _jsxs("div", { className: "flex items-center", children: [getStatusIcon(device.status_text), _jsx("span", { className: `ml-2 px-2 py-1 rounded-full text-xs ${device.status_text === 'online'
                                                                    ? 'bg-green-900/20 text-green-400'
                                                                    : 'bg-red-900/20 text-red-400'}`, children: getStatusText(device.status_text) })] }) }), _jsx("td", { className: "py-3 px-4 font-mono", children: device.ip || device.ip_address || '-' }), _jsx("td", { className: "py-3 px-4", children: _jsx("span", { className: "text-gray-300", children: device.platform_id || '-' }) }), _jsx("td", { className: "py-3 px-4", children: _jsx(Tooltip, { content: type === 'addreality' ? (_jsxs("div", { children: [_jsxs("div", { children: [_jsx("b", { children: "\u0412\u0435\u0440\u0441\u0438\u044F \u043F\u043B\u0435\u0435\u0440\u0430:" }), " ", device.player_version || '-'] }), _jsxs("div", { children: [_jsx("b", { children: "TimeZone:" }), " ", device.time_zone || '-'] }), _jsxs("div", { children: [_jsx("b", { children: "Activation:" }), " ", device.activation_state || '-'] }), _jsxs("div", { children: [_jsx("b", { children: "Last online:" }), " ", device.last_online || '-'] })] })) : (_jsxs("div", { children: [_jsxs("div", { children: [_jsx("b", { children: "MAC:" }), " ", device.mac || device.mac_address || '-'] }), _jsxs("div", { children: [_jsx("b", { children: "IP:" }), " ", device.ip || device.ip_address || '-'] }), _jsxs("div", { children: [_jsx("b", { children: "Last seen:" }), " ", device.last_seen || '-'] })] })), children: _jsx(Eye, { className: "text-gray-400 hover:text-blue-400 cursor-pointer", size: 18 }) }) })] }, index));
                                    }) })] }) })), selectedDevice && (_jsx(Modal, { open: !!selectedDevice, onClose: () => setSelectedDevice(null), children: _jsxs("div", { className: "p-6", children: [_jsx("h2", { className: "text-xl font-bold mb-4", children: "\u0414\u0435\u0442\u0430\u043B\u0438 \u0443\u0441\u0442\u0440\u043E\u0439\u0441\u0442\u0432\u0430" }), _jsxs("div", { className: "space-y-2", children: [_jsxs("div", { children: [_jsx("b", { children: "\u0418\u0441\u0442\u043E\u0447\u043D\u0438\u043A:" }), " ", (selectedDevice.platform_type || getDeviceType(selectedDevice)) === 'addreality' ? 'AddReality' : 'CubicMedia'] }), _jsxs("div", { children: [_jsx("b", { children: "ID/MAC:" }), " ", selectedDevice.device_id || selectedDevice.mac || selectedDevice.mac_address || '-'] }), _jsxs("div", { children: [_jsx("b", { children: "\u0418\u043C\u044F:" }), " ", selectedDevice.name || '-'] }), _jsxs("div", { children: [_jsx("b", { children: "\u041F\u043B\u0430\u0442\u0444\u043E\u0440\u043C\u0430:" }), " ", selectedDevice.platform_id || '-'] }), _jsxs("div", { children: [_jsx("b", { children: "\u0421\u0442\u0430\u0442\u0443\u0441:" }), " ", getStatusText(selectedDevice.status_text)] }), getDeviceType(selectedDevice) === 'addreality' ? (_jsxs(_Fragment, { children: [_jsxs("div", { children: [_jsx("b", { children: "\u0412\u0435\u0440\u0441\u0438\u044F \u043F\u043B\u0435\u0435\u0440\u0430:" }), " ", selectedDevice.player_version || '-'] }), _jsxs("div", { children: [_jsx("b", { children: "TimeZone:" }), " ", selectedDevice.time_zone || '-'] }), _jsxs("div", { children: [_jsx("b", { children: "Activation:" }), " ", selectedDevice.activation_state || '-'] }), _jsxs("div", { children: [_jsx("b", { children: "Last online:" }), " ", selectedDevice.last_online || '-'] })] })) : (_jsxs(_Fragment, { children: [_jsxs("div", { children: [_jsx("b", { children: "IP:" }), " ", selectedDevice.ip || selectedDevice.ip_address || '-'] }), _jsxs("div", { children: [_jsx("b", { children: "\u0412\u043D\u0435\u0448\u043D\u0438\u0439 IP:" }), " ", selectedDevice.outip || '-'] }), _jsxs("div", { children: [_jsx("b", { children: "Last seen:" }), " ", selectedDevice.last_seen || '-'] })] }))] }), _jsx("div", { className: "mt-6 text-right", children: _jsx(Button, { onClick: () => setSelectedDevice(null), variant: "secondary", children: "\u0417\u0430\u043A\u0440\u044B\u0442\u044C" }) })] }) }))] })] }));
};
export default DevicesPrometheusPage;
