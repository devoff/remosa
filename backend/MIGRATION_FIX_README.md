# Исправление проблем с миграциями на продакшене

## Проблема
При переносе кода на продакшн сервер возникают ошибки миграций из-за того, что база данных уже содержит некоторые таблицы и колонки, которые миграции пытаются создать повторно.

## Решение

### 1. Проверка состояния базы данных

```bash
cd /app  # или путь к backend
export POSTGRES_HOST=your_host
export POSTGRES_PORT=5432
export POSTGRES_DB=remosa
export POSTGRES_USER=remosa
export POSTGRES_PASSWORD=your_password
export SECRET_KEY=your_secret_key
export JWT_SECRET_KEY=your_jwt_secret

python3 fix_migrations.py check
```

### 2. Запуск исправленных миграций

```bash
alembic upgrade head
```

## Исправленные файлы миграций

Были исправлены следующие миграции для корректной работы на продакшене:

1. **f6eacc8b57c9_update_user_model_and_add_platform_id_.py**
   - Добавлены проверки существования таблиц и constraints перед их удалением
   - Добавлены try/except блоки для безопасного создания индексов

2. **3dcc96070dd4_fix_add_user_id_to_devices.py**
   - Добавлена проверка существования колонки user_id перед ее добавлением
   - Добавлена проверка существования foreign key constraint

3. **24276f29880d_platforms_platform_users_audit_logs_.py**
   - Добавлены проверки существования всех создаваемых таблиц
   - Добавлены проверки существования колонок перед их добавлением
   - Безопасное создание индексов и constraints

4. **587cab78bf8f_add_superadmin_user.py** (новая)
   - Создание суперадмин пользователя admin@admin.ru / 05021983

## Что исправлено

- ✅ Безопасное удаление constraints и таблиц (проверка существования)
- ✅ Безопасное создание таблиц и колонок
- ✅ Безопасное создание индексов и foreign keys
- ✅ Создание суперадмин пользователя
- ✅ Обработка различных состояний базы данных

## Суперадмин доступ

После успешного выполнения миграций будет создан суперадмин пользователь:
- **Email:** admin@admin.ru
- **Пароль:** 05021983
- **Роль:** superadmin
- **Доступ:** ко всем платформам

## В случае проблем

Если миграция все еще не проходит:

1. Проверьте состояние базы:
```bash
python3 fix_migrations.py check
```

2. Если нужно пропустить конкретную миграцию (пометить как выполненную):
```bash
python3 fix_migrations.py mark REVISION_ID
```

3. Затем попробуйте снова:
```bash
alembic upgrade head
```

## Порядок действий на продакшене

1. Скопировать исправленные файлы миграций
2. Установить переменные окружения
3. Запустить `alembic upgrade head`
4. Проверить создание суперадмин пользователя
5. Запустить приложение 