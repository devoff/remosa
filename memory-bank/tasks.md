# Task: Встроенная система экспортеров для Prometheus

## Описание
Создание комплексной системы экспортеров для Prometheus с поддержкой разных платформ (CubicMedia, Addreality), настройкой через веб-интерфейс и системой автоматизации задач для управления устройствами.

## Complexity
Level: 4  
Type: Complex System

## Technology Stack
- **Backend**: FastAPI + SQLAlchemy (уже настроен)
- **Frontend**: React + TypeScript (уже настроен)  
- **Database**: PostgreSQL с Alembic миграциями
- **Exporters**: Python Flask/FastAPI микросервисы для каждого типа экспортера
- **Monitoring**: Prometheus для сбора метрик
- **Infrastructure**: Docker + Docker Compose
- **Message Queue**: Для обработки задач (Redis/Celery или аналог)

## Technology Validation Checkpoints
- [x] Изучена архитектура существующего json_exporter (/opt/json_exporter)
- [x] Определена архитектура микросервисов экспортеров
- [x] Спроектированы модели данных для экспортеров и заданий
- [x] Выбрана система очередей для обработки задач
- [x] Настроена интеграция с Prometheus

## Status
- [x] В работе - VAN анализ завершен
- [x] Planning
- [x] Creative Design
- [x] Implementation - Phase 3 Backend разработка
- [x] Implementation - Phase 4 Экспортеры
- [x] Implementation - Phase 5 Frontend разработка
- [x] Implementation - Phase 6 Система автоматизации
- [x] **Implementation - Phase 7 CubicExporter завершен ✅**
- [ ] QA Testing
- [ ] Reflection
- [ ] Archive

## Key Requirements

### 1. Архитектура экспортеров
- Каждый экспортер = отдельный Docker контейнер
- Поддерживаемые системы: CubicMedia, Addreality
- Каждый экспортер экспортирует метрики для Prometheus + API для Remosa
- Привязка экспортеров к платформам через platform_id в лейблах

### 2. Решение проблемы с IP-адресами в метриках
- **Основная метрика**: `json_exporter_device_status{name="device_name", platform_id="123"}` (без IP)
- **Info метрика**: `json_exporter_device_info{name="device_name", ip="192.168.1.1", platform_id="123"} 1`
- Сохранение временных рядов при изменении IP

### 3. CubicMedia экспортер (расширение существующего)
- API endpoint: `https://vision-cms-api.cubicservice.ru/api/v0.1/players/status-check?mac=`
- Настройка списка MAC адресов через UI
- Кэширование в SQLite для оффлайн работы
- Интеграция существующего кода из `/opt/json_exporter`

### 4. Backend интеграция
- Настройки подключения к Prometheus (только superadmin)
- API для получения списка устройств из Prometheus
- Управление конфигурацией экспортеров для каждой платформы
- Система заданий для автоматизации (аналог Grafana Alert)

### 5. Frontend функциональность
- Страница настройки экспортеров для каждой платформы
- Список устройств из Prometheus с лейблами
- Мастер создания заданий для перезагрузки устройств
- Привязка устройств к шаблонам команд
- Настройка триггеров и условий выполнения

### 6. Система автоматизации задач
- Создание заданий на основе метрик Prometheus
- Выполнение действий на устройствах по шаблонам
- Логирование и аудит всех действий
- Уведомления о результатах выполнения

## Implementation Plan

### Phase 1: Архитектурное планирование (PLAN)
- [x] Анализ существующего json_exporter
- [x] Проектирование архитектуры микросервисов
- [x] Определение моделей данных
- [x] Планирование интеграции с основной системой

### Phase 2: Дизайн системы (CREATIVE) 
- [x] UI/UX дизайн страниц управления экспортерами
- [x] API дизайн для взаимодействия с экспортерами
- [x] Дизайн системы заданий и автоматизации
- [x] Решение архитектурных вопросов

### Phase 3: Backend разработка (IMPLEMENT) ✅
- [x] Модели для экспортеров, заданий и конфигураций
- [x] API эндпоинты для управления экспортерами
- [x] API эндпоинты для системы заданий
- [x] Интеграция с Prometheus
- [x] Система обработки заданий
- [x] Миграции базы данных

### Phase 4: Экспортеры (IMPLEMENT) ✅
- [x] Рефакторинг существующего CubicMedia экспортера
- [x] Создание базового экспортера Addreality
- [x] Docker конфигурация для экспортеров
- [x] Интеграция с системой конфигурации

### Phase 5: Frontend разработка (IMPLEMENT) ✅
- [x] Страница управления экспортерами
- [x] Интерфейс настройки CubicMedia экспортера
- [x] Список устройств из Prometheus
- [x] Мастер создания заданий
- [x] Настройка триггеров и автоматизации

### Phase 6: Система автоматизации (IMPLEMENT) ✅
- [x] Обработчик заданий
- [x] Интеграция с шаблонами команд
- [x] Система уведомлений
- [x] Мониторинг выполнения заданий

### Phase 7: CubicExporter - Полная реализация (IMPLEMENT) ✅
- [x] **Создан новый экспортер CubicExporter в отдельной папке**
- [x] **Реализована вся логика по новому ТЗ:**
  - Метрики с правильными лейблами (status: platform_id, exporter_id, mac; info: полные лейблы)
  - Интеграция с REMOSA API для получения MAC-адресов
  - Настройка через .env файл
  - Параллельная обработка запросов (ThreadPoolExecutor)
  - Кэширование в SQLite для оффлайн работы
  - Отладочный режим через DEBUG_MODE
- [x] **Доработан backend для поддержки CubicExporter:**
  - CRUD для MAC-адресов экспортёра (добавление, удаление, редактирование)
  - Эндпоинт `/api/v1/exporter-macs` для получения всех MAC-адресов
  - Массовое добавление/удаление MAC-адресов через API
- [x] **Доработан frontend:**
  - Убрано поле API Endpoint из формы создания экспортёра
  - Platform ID автозаполняется
  - MAC-адреса: textarea для массового ввода с валидацией
  - UI для просмотра, редактирования, удаления MAC-адресов
- [x] **Формат API для экспортёра:**
  - Экспортер получает JSON-массив объектов: platform_id, mac, name, ip, outip
  - Поддержка фильтрации по платформе
- [x] **Исправлены все проблемы:**
  - Параллельная обработка запросов (как в старой версии)
  - Правильные лейблы метрик
  - Отладочный режим с подробным логированием
  - Пересборка контейнера без кэша
- [x] **Экспортер полностью работает и отдает метрики:**
  ```
  remosa_exporter_cubic_device_status{exporter_id="4",mac="06:42:40:92:60:B4",platform_id="1"} 0.0
  remosa_exporter_cubic_device_info{exporter_id="4",ip="192.168.111.27",mac="06:42:40:92:60:B4",name="ММ Зауролоф LED",outip="94.72.61.150",platform_id="1"} 1.0
  ```

## Current Analysis

### Существующий json_exporter (/opt/json_exporter):
- **Технологии**: Flask + prometheus_client + SQLite
- **Функциональность**: Экспорт метрик CubicMedia через JSON API
- **Проблемы**: IP адреса в лейблах ломают временные ряды
- **Состояние**: Рабочий прототип, требует рефакторинга

### Архитектура Remosa:
- **Backend**: FastAPI + SQLAlchemy + PostgreSQL
- **Frontend**: React + TypeScript + Tailwind CSS
- **Infrastructure**: Docker + nginx
- **Features**: Мультитенантность, ролевая система, платформы

## Dependencies
- [x] Система платформ и ролей реализована
- [x] Docker инфраструктура настроена
- [ ] Prometheus сервер (требует настройки)
- [ ] Система очередей (требует выбора и настройки)
- [ ] Шаблоны команд устройств (могут потребовать расширения)

## Challenges & Mitigations

- **Challenge**: Интеграция существующего json_exporter с новой архитектурой
  **Mitigation**: Постепенная миграция с сохранением обратной совместимости

- **Challenge**: Проблема с IP адресами в метриках Prometheus  
  **Mitigation**: Разделение на основную метрику (без IP) и info метрику (с IP)

- **Challenge**: Масштабирование системы экспортеров
  **Mitigation**: Микросервисная архитектура с независимыми контейнерами

- **Challenge**: Настройка Prometheus интеграции
  **Mitigation**: Создание отдельного сервиса для работы с Prometheus API

- **Challenge**: Система автоматизации заданий
  **Mitigation**: Использование проверенных решений (Celery/Redis или аналоги)

## Expected Outcomes
- Масштабируемая система экспортеров для разных платформ
- Решение проблемы с IP адресами в Prometheus метриках  
- Полная интеграция с существующей системой Remosa
- Система автоматизации управления устройствами
- Готовность к добавлению новых типов экспортеров

## Success Criteria
- [x] CubicMedia экспортер работает с новой архитектурой
- [x] Базовый Addreality экспортер создан и функционален
- [x] UI позволяет настраивать экспортеры для платформ
- [x] Prometheus получает корректные метрики с platform_id
- [x] Система заданий выполняет автоматизацию
- [x] Все компоненты интегрированы с основной системой
- [x] **CubicExporter полностью реализован и работает:**
  - Параллельная обработка запросов
  - Правильные метрики с корректными лейблами
  - Интеграция с REMOSA API
  - Отладочный режим
  - Кэширование в SQLite

---

# VAN Analysis Completed ✅

## Анализ проекта завершен:

### Текущая архитектура Remosa:
- ✅ **Мультитенантная система** с платформами и ролями
- ✅ **Docker инфраструктура** готова для микросервисов
- ✅ **React + FastAPI** стек готов к расширению
- ✅ **PostgreSQL** с миграциями для новых моделей

### Существующий экспортер:
- ✅ **CubicMedia экспортер** частично реализован в `/opt/json_exporter`
- ✅ **Flask + prometheus_client** архитектура понятна
- ✅ **SQLite кэширование** для надежности работы
- ❌ **Проблема с IP в лейблах** требует решения

### Ключевые выводы:
1. **Level 4 задача подтверждена** - требует архитектурных изменений
2. **Существующий код переиспользуется** - нужен рефакторинг, не переписывание
3. **Микросервисная архитектура** - каждый экспортер в отдельном контейнере
4. **Prometheus интеграция** - нужна настройка и API для чтения метрик

**ГОТОВ К ПЕРЕХОДУ В PLAN РЕЖИМ** 🚀

**NEXT**: Переходим к PLAN для детального планирования архитектуры и этапов реализации.
